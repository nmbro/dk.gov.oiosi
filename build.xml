<?xml version="1.0"?>
<project name="NemHandel" default="all">

  <property name="Revision" value="${build.number}"/>
  <property name="Dist.dir" value="target\dist"/>
  <property name="Temp.dir" value="target\temp"/>
  <property name="VisualStudioSolution.file" value="dk.gov.oiosi.library.sln"/>
  <property name="Root.dir" value="."/>
  <property name="Oiosi.dir" value="src\dk.gov.oiosi"/>
  <property name="Lesnikowski.dir" value="src\dk.gov.oiosi.lesnikowskiMailProvider"/>
  <property name="Xml.dir" value="src\dk.gov.oiosi.xml"/>
  <property name="RaspProfile.dir" value="src\dk.gov.oiosi.raspProfile"/>
  <property name="UnitTest.file" value="test/dk.gov.oiosi.test.unit/bin/release/dk.gov.oiosi.test.unit.dll"/>
  <property name="IntegrationTest.file" value="test/dk.gov.oiosi.test.integration/bin/release/dk.gov.oiosi.test.integration.dll"/>
  
  <target name="Clean" description="Remove all build products">
        <delete dir="${Dist.dir}"  if="${directory::exists('${Dist.dir}')}" />
    </target>

    <target name="Init" depends="Clean">
        <mkdir dir="${Dist.dir}" />
        <mkdir dir="${Temp.dir}" />
    </target>

    <target name="SetVersion" depends="Init">
      <asminfo language="CSharp" output="${Oiosi.dir}\Properties\AssemblyInfo.cs">
        <imports>
          <import namespace="System.Reflection" />
        </imports>
        <attributes>
          <attribute type="AssemblyVersionAttribute" value="1.2.0.0" />
          <attribute type="AssemblyFileVersionAttribute" value="${Revision}" />
		  <attribute type="AssemblyDescriptionAttribute" value="dk.gov.oiosi.library ${Revision}" />
        </attributes>
      </asminfo>
    </target>
   
   <target name="BuildVisualStudioSolutionNet35" depends="SetVersion">
     <msbuild project="${VisualStudioSolution.file}" target="Rebuild">
       <property name="Configuration" value="Debug" />
       <property name="teamcity_dotnet_use_msbuild_v35" value="true" />
     </msbuild>

    <msbuild project="${VisualStudioSolution.file}" target="Rebuild">
       <property name="Configuration" value="Release" />
       <property name="teamcity_dotnet_use_msbuild_v35" value="true" />
     </msbuild>
   </target>

   <target name="RunTests">
     <exec program="${teamcity.dotnet.nunitlauncher2.0}">
       <arg file="${UnitTest.file}"/>
	   <arg file="${IntegrationTest.file}"/>
     </exec>
   </target>


   <target name="Distribute" depends="RunTests">
     
     <!-- Executable -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi-bin-${Revision}.zip">
       <fileset basedir="${Oiosi.dir}\bin\Release">
         <include name="**/*" />
       </fileset>
     </zip>
     
     <!-- Lesnikowski Mail Provider -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi.lesnikowskiMailProvider-${Revision}.zip">
       <fileset basedir="${Lesnikowski.dir}\bin\Release">
         <include name="**/*" />
       </fileset>
     </zip>


     <!-- Rasp profile library -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi.raspProfile-${Revision}.zip">
       <fileset basedir="${RaspProfile.dir}\bin\Release">
         <include name="**/*" />
       </fileset>
     </zip>

     
     <!-- XML shared library -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi.xml-${Revision}.zip">
       <fileset basedir="${Xml.dir}\bin\Release">
         <include name="**/*" />
       </fileset>
     </zip>

     
     <!-- Rasp profile resources - input to msi -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi.raspProfile-msi-input.zip">
       <fileset basedir="${RaspProfile.dir}\Resources">
         <include name="**/*" />
       </fileset>
     </zip>

     <!-- Source section -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi-src-${Revision}.zip">
       <fileset basedir="${Root.dir}">
         <include name="**/*" />
         <exclude name="**/bin" />
         <exclude name="**/bin/**" />
         <exclude name="**/obj" />
         <exclude name="**/obj/**" />
		 <exclude name="target/**" />
		 <exclude name="*.resharper" />
		 <exclude name="*.cache" />
		 <exclude name="build.xml" />
       </fileset>
     </zip>

	<!-- Source with bin folder - input to help file -->
     <zip zipfile="${Dist.dir}\dk.gov.oiosi-src-helpfile-input.zip">
       <fileset basedir="${Root.dir}">
         <include name="**/*" />
       </fileset>
     </zip>
   </target>

</project>